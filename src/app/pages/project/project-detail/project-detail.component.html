<app-navbar></app-navbar>

<div class="container max-w-4xl mx-auto p-4 md:p-6 lg:p-8">
  <!-- Notifications Toast -->
  <div class="fixed top-4 right-4 space-y-2 z-50 max-w-xs w-full">
    <div
      *ngFor="let toast of toasts"
      [ngClass]="{
        'bg-green-500 text-primary-foreground': toast.type === 'success',
        'bg-destructive text-destructive-foreground': toast.type === 'error'
      }"
      class="px-4 py-3 rounded-lg shadow-lg transition-all duration-300 animate-fade-in"
    >
      <div class="flex items-center gap-3">
        <svg
          *ngIf="toast.type === 'success'"
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="flex-shrink-0"
        >
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <svg
          *ngIf="toast.type === 'error'"
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="flex-shrink-0"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" x2="12" y1="8" y2="12"></line>
          <line x1="12" x2="12.01" y1="16" y2="16"></line>
        </svg>
        <p class="text-sm">{{ toast.message }}</p>
      </div>
    </div>
  </div>

  <!-- Breadcrumb simplifié -->
  <nav class="flex mb-6">
    <ol class="flex items-center space-x-2 text-sm text-muted-foreground">
      <li class="flex items-center">
        <a
          href="/"
          class="inline-flex items-center hover:text-primary hover:underline underline-offset-4 transition-colors duration-200 ease-in-out"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="mr-1.5"
          >
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          Accueil
        </a>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="mx-2 text-muted-foreground/60"
        >
          <path d="m9 18 6-6-6-6"></path>
        </svg>
      </li>
      <li class="flex items-center">
        <span class="text-foreground font-medium">
          {{ project.title }}
        </span>
      </li>
    </ol>
  </nav>

  <!-- En-tête du Projet -->
  <div class="flex flex-col gap-4 mb-8">
    <div class="flex justify-between items-start gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-foreground">
          {{ project.title }}
        </h1>
        <p class="text-muted-foreground mt-1 text-sm">
          Créé le {{ project.created_at | date : "d MMM yyyy" | lowercase }}
        </p>
      </div>

      <div class="flex items-center gap-2" *ngIf="isOwner">
        <!-- Bouton modifier le projet -->
        <button
          [routerLink]="['/project/edit', project.slug]"
          class="p-2 rounded-md hover:bg-accent transition-colors focus:outline-none focus:ring-2 focus:ring-ring"
          aria-label="Modifier le projet"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
            <path d="m15 5 4 4"></path>
          </svg>
        </button>

        <!-- Bouton changer le statut du projet -->
        <button
          class="p-2 rounded-md hover:bg-accent transition-colors focus:outline-none focus:ring-2 focus:ring-ring"
          aria-label="Changer le statut du projet"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
            <path d="M12 7v5l4 2"></path>
          </svg>
        </button>

        <!-- Bouton supprimer le projet -->
        <button
          (click)="onDeleteProject()"
          class="p-2 rounded-md hover:bg-destructive/10 transition-colors focus:outline-none focus:ring-2 focus:ring-ring text-destructive"
          aria-label="Supprimer le projet"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M3 6h18"></path>
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Vue pour le propriétaire (avec onglets) -->
  <ng-container *ngIf="isOwner">
    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
      <!-- En-tête des Tabs -->
      <div class="border-b border-border">
        <nav class="flex">
          <button
            (click)="activeTab = 'informations'"
            [class.border-b-2]="activeTab === 'informations'"
            [class.border-primary]="activeTab === 'informations'"
            [class.text-primary]="activeTab === 'informations'"
            [class.font-medium]="activeTab === 'informations'"
            class="px-4 py-3 text-sm hover:bg-muted/50 transition-colors"
          >
            Informations
          </button>
          <button
            (click)="activeTab = 'roles'"
            [class.border-b-2]="activeTab === 'roles'"
            [class.border-primary]="activeTab === 'roles'"
            [class.text-primary]="activeTab === 'roles'"
            [class.font-medium]="activeTab === 'roles'"
            class="px-4 py-3 text-sm hover:bg-muted/50 transition-colors"
          >
            Rôles
          </button>
          <button
            (click)="activeTab = 'candidatures'"
            [class.border-b-2]="activeTab === 'candidatures'"
            [class.border-primary]="activeTab === 'candidatures'"
            [class.text-primary]="activeTab === 'candidatures'"
            [class.font-medium]="activeTab === 'candidatures'"
            class="px-4 py-3 text-sm hover:bg-muted/50 transition-colors"
          >
            Candidatures
          </button>
          <button
            (click)="activeTab = 'invitations'"
            [class.border-b-2]="activeTab === 'invitations'"
            [class.border-primary]="activeTab === 'invitations'"
            [class.text-primary]="activeTab === 'invitations'"
            [class.font-medium]="activeTab === 'invitations'"
            class="px-4 py-3 text-sm hover:bg-muted/50 transition-colors"
          >
            Invitations
          </button>
        </nav>
      </div>

      <!-- Contenu des Tabs -->
      <div class="p-4">
        <!-- Onglet Informations -->
        <div *ngIf="activeTab === 'informations'">
          <section class="space-y-6">
            <!-- Description -->
            <div>
              <h3 class="text-base font-medium text-foreground mb-2">
                Description
              </h3>
              <p
                class="text-muted-foreground leading-relaxed whitespace-pre-line"
              >
                {{ project.description || "Aucune description fournie" }}
              </p>
            </div>

            <!-- Statut -->
            <div class="flex items-center gap-4">
              <h3 class="text-base font-medium text-foreground">Statut :</h3>
              <span
                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium border"
                [ngClass]="{
                  'bg-green-500/10 text-green-600 border-green-500/20':
                    project.status.name === 'En cours',
                  'bg-red-500/10 text-red-600 border-red-500/20':
                    project.status.name === 'Terminé',
                  'bg-accent text-foreground border-border':
                    project.status.name !== 'En cours' &&
                    project.status.name !== 'Terminé'
                }"
              >
                <span class="relative flex h-2 w-2">
                  <span
                    *ngIf="project.status.name === 'En cours'"
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"
                  ></span>
                  <span
                    *ngIf="project.status.name === 'En cours'"
                    class="relative inline-flex rounded-full h-2 w-2 bg-green-500"
                  ></span>
                  <span
                    *ngIf="project.status.name === 'Terminé'"
                    class="relative inline-flex rounded-full h-2 w-2 bg-red-500"
                  ></span>
                </span>
                {{ project.status.name }}
              </span>
            </div>

            <!-- Domaines -->
            <div>
              <h3 class="text-base font-medium text-foreground mb-3">
                Domaines concernés
              </h3>
              <div class="flex flex-wrap gap-2">
                <span
                  *ngFor="let domain of project.domains"
                  class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-500/10 text-orange-600 border border-orange-500/20"
                >
                  {{ domain.name }}
                </span>
                <span
                  *ngIf="!project.domains?.length"
                  class="text-sm text-muted-foreground"
                >
                  Aucun domaine spécifié
                </span>
              </div>
            </div>

            <!-- Détails du projet -->
            <div>
              <h3 class="text-base font-medium text-foreground mb-3">
                Détails du projet
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <!-- Date de début -->
                <div
                  class="flex items-center gap-3 p-3 bg-accent rounded-lg border border-border"
                >
                  <div class="p-2 rounded-lg bg-accent text-muted-foreground">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M8 2v4"></path>
                      <path d="M16 2v4"></path>
                      <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                      <path d="M3 10h18"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="text-xs text-muted-foreground">Début</p>
                    <p class="text-sm font-medium text-foreground">
                      {{ project.date_start | date : "d MMM yyyy" | lowercase }}
                    </p>
                  </div>
                </div>

                <!-- Date de fin -->
                <div
                  class="flex items-center gap-3 p-3 bg-accent rounded-lg border border-border"
                >
                  <div class="p-2 rounded-lg bg-accent text-muted-foreground">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M8 2v4"></path>
                      <path d="M16 2v4"></path>
                      <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                      <path d="M3 10h18"></path>
                      <path d="M9 16l2 2 4-4"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="text-xs text-muted-foreground">Fin prévue</p>
                    <p class="text-sm font-medium text-foreground">
                      {{ project.date_end | date : "d MMM yyyy" | lowercase }}
                    </p>
                  </div>
                </div>

                <!-- Budget -->
                <div
                  class="flex items-center gap-3 p-3 bg-accent rounded-lg border border-border"
                >
                  <div class="p-2 rounded-lg bg-accent text-muted-foreground">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <line x1="12" x2="12" y1="2" y2="22"></line>
                      <path
                        d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                      ></path>
                    </svg>
                  </div>
                  <div>
                    <p class="text-xs text-muted-foreground">Budget</p>
                    <p class="text-sm font-medium text-foreground">
                      {{ project.budget || "Non spécifié" }}
                    </p>
                  </div>
                </div>

                <!-- Localisation -->
                <div
                  class="flex items-center gap-3 p-3 bg-accent rounded-lg border border-border"
                >
                  <div class="p-2 rounded-lg bg-accent text-muted-foreground">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"
                      ></path>
                      <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                  </div>
                  <div>
                    <p class="text-xs text-muted-foreground">Localisation</p>
                    <p class="text-sm font-medium text-foreground">
                      {{ project.location || "Non spécifié" }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Onglet Rôles -->
        <div *ngIf="activeTab === 'roles'">
          <div class="space-y-2">
            <ng-container
              *ngFor="
                let roleSkill of project.project_roles_skills;
                let i = index
              "
            >
              <div class="border border-border rounded-lg overflow-hidden">
                <!-- En-tête de l'accordéon -->
                <button
                  (click)="toggleAccordion(i)"
                  class="w-full flex justify-between items-center p-4 hover:bg-accent transition-colors"
                >
                  <div class="flex items-center gap-3">
                    <h3
                      class="text-base font-semibold text-foreground text-left"
                    >
                      {{ roleSkill.role.name }}
                    </h3>
                    <div class="flex flex-wrap gap-1">
                      <span
                        *ngFor="let skill of roleSkill.skills"
                        class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-500/10 text-orange-500"
                      >
                        {{ skill.name }}
                      </span>
                    </div>
                  </div>
                  <svg
                    [class.rotate-180]="isOpen[i]"
                    class="w-5 h-5 text-muted-foreground transform transition-transform"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>

                <!-- Contenu de l'accordéon -->
                <div
                  [class.hidden]="!isOpen[i]"
                  class="p-4 pt-0 border-t border-border"
                >
                  <div class="flex flex-col gap-4">
                    <div>
                      <p class="text-muted-foreground">
                        {{
                          roleSkill.description ||
                            "Aucune description spécifique pour ce rôle."
                        }}
                      </p>
                    </div>

                    <div *ngIf="roleSkill.skills.length > 0" class="mt-2">
                      <h4 class="text-sm font-medium text-foreground mb-2">
                        Compétences requises
                      </h4>
                      <div class="flex flex-wrap gap-2">
                        <span
                          *ngFor="let skill of roleSkill.skills"
                          class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-500/10 text-orange-500"
                        >
                          {{ skill.name }}
                        </span>
                      </div>
                    </div>

                    <div class="flex justify-between items-center mt-4">
                      <div class="flex gap-4 text-sm text-muted-foreground">
                        <span class="flex items-center gap-1">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <path
                              d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"
                            ></path>
                            <circle cx="9" cy="7" r="4"></circle>
                          </svg>
                          {{ roleSkill.candidacies_count }} candidature(s)
                        </span>
                        <span
                          *ngIf="roleSkill.invitations_count > 0"
                          class="flex items-center gap-1"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <path
                              d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                            ></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                          </svg>
                          {{ roleSkill.invitations_count }} invitation(s)
                        </span>
                      </div>

                      <button
                        (click)="openInviteModal(roleSkill)"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary/90"
                      >
                        Inviter
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Onglet Candidatures -->
        <div *ngIf="activeTab === 'candidatures'">
          <!-- Filtres -->
          <div class="p-4 border-b border-border">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold text-foreground">
                Candidatures
              </h2>
              <span *ngIf="candidacyMeta" class="text-sm text-muted-foreground">
                {{ candidacyMeta.total }} résultat(s)
              </span>
              <button
                (click)="refreshCandidacies()"
                [disabled]="isLoading"
                class="p-1.5 rounded-md hover:bg-muted transition"
                title="Actualiser les candidatures"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  [class.animate-spin]="isLoading"
                >
                  <path
                    d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                  />
                  <path d="M3 3v5h5" />
                  <path
                    d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"
                  />
                  <path d="M16 16h5v5" />
                </svg>
              </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mt-3">
              <div>
                <label class="block text-sm font-medium text-foreground mb-1"
                  >Rôle</label
                >
                <input
                  type="text"
                  [(ngModel)]="roleFilter"
                  placeholder="Rôle"
                  class="w-full text-sm rounded-md border border-input bg-background px-3 py-2 shadow-sm focus:ring-2 focus:ring-ring focus:ring-offset-2"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-foreground mb-1"
                  >Utilisateur</label
                >
                <input
                  type="text"
                  [(ngModel)]="userFilter"
                  placeholder="Nom"
                  class="w-full text-sm rounded-md border border-input bg-background px-3 py-2 shadow-sm focus:ring-2 focus:ring-ring focus:ring-offset-2"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-foreground mb-1"
                  >Statut</label
                >
                <select
                  [(ngModel)]="validatedFilter"
                  class="w-full text-sm rounded-md border border-input bg-background px-3 py-2 shadow-sm focus:ring-2 focus:ring-ring focus:ring-offset-2"
                >
                  <option [ngValue]="-1">Tous</option>
                  <option [ngValue]="1">Validé</option>
                  <option [ngValue]="0">Non validé</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-foreground mb-1"
                  >Par page</label
                >
                <select
                  [(ngModel)]="perPage"
                  (change)="onPerPageChange()"
                  class="w-full text-sm rounded-md border border-input bg-background px-3 py-2 shadow-sm focus:ring-2 focus:ring-ring focus:ring-offset-2"
                >
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="20">20</option>
                </select>
              </div>
              <div class="flex items-end gap-2">
                <button
                  (click)="applyFilters()"
                  class="w-full text-sm bg-primary text-primary-foreground px-3 py-2 rounded-md hover:bg-primary/90 transition"
                >
                  Appliquer
                </button>
                <button
                  (click)="resetFilters()"
                  class="w-full text-sm border border-input px-3 py-2 rounded-md hover:bg-muted transition"
                >
                  Réinitialiser
                </button>
              </div>
            </div>
          </div>

          <!-- Tableau des Candidatures -->
          <div class="p-4">
            <div class="overflow-x-auto rounded-lg border border-border">
              <table class="min-w-full text-sm text-left">
                <thead class="bg-muted">
                  <tr>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Candidat
                    </th>
                    <th class="px-4 py-3 font-medium text-foreground">Email</th>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Rôle Postulé
                    </th>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Validation
                    </th>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Statut
                    </th>
                    <th class="px-4 py-3 font-medium text-foreground">Date</th>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <!-- État de Chargement -->
                  <tr *ngIf="isLoading">
                    <td colspan="7" class="py-6 text-center">
                      <div class="flex justify-center items-center space-x-2">
                        <div
                          class="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-primary"
                        ></div>
                        <span class="text-muted-foreground">Chargement...</span>
                      </div>
                    </td>
                  </tr>

                  <!-- État Vide -->
                  <tr *ngIf="!isLoading && candidacies.length === 0">
                    <td colspan="7" class="py-6 text-center">
                      <div
                        class="flex flex-col items-center justify-center space-y-2 text-muted-foreground"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="lucide lucide-file-search"
                        >
                          <path
                            d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3"
                          />
                          <path d="M14 2v6h6" />
                          <circle cx="10" cy="13" r="3" />
                          <path d="m12 12-1 1" />
                        </svg>
                        <span>Aucune candidature trouvée</span>
                      </div>
                    </td>
                  </tr>

                  <!-- Candidatures -->
                  <tr
                    *ngFor="let candidacy of candidacies"
                    class="hover:bg-muted/50 transition-colors"
                  >
                    <td class="px-4 py-3 font-medium">
                      <div class="flex items-center space-x-3">
                        <div
                          class="flex-shrink-0 h-8 w-8 rounded-full bg-muted flex items-center justify-center"
                        >
                          <span
                            class="text-sm font-medium text-muted-foreground"
                          >
                            {{
                              candidacy.user.name | slice : 0 : 1 | uppercase
                            }}
                          </span>
                        </div>
                        <span class="text-foreground">{{
                          candidacy.user.name
                        }}</span>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-muted-foreground">
                      {{ candidacy.user.email }}
                    </td>
                    <td class="px-4 py-3">
                      <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-secondary text-secondary-foreground"
                      >
                        {{ candidacy.project_role.role.name }}
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300':
                            candidacy.is_validated,
                          'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300':
                            !candidacy.is_validated
                        }"
                      >
                        {{ candidacy.is_validated ? "Oui" : "Non" }}
                      </span>
                    </td>
                    <td class="px-4 py-3 text-muted-foreground">
                      {{ candidacy.status }}
                    </td>
                    <td
                      class="px-4 py-3 whitespace-nowrap text-muted-foreground"
                    >
                      {{ candidacy.created_at | date : "dd/MM/yyyy" }}
                    </td>
                    <td class="px-4 py-3 relative">
                      <!-- Bouton d'actions -->
                      <div class="dropdown relative">
                        <button
                          (click)="toggleViewMenu(candidacy.id)"
                          class="inline-flex items-center justify-center p-2 rounded-md hover:bg-muted/50 transition-colors"
                          aria-label="Actions"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="lucide lucide-more-horizontal"
                          >
                            <circle cx="12" cy="12" r="1" />
                            <circle cx="19" cy="12" r="1" />
                            <circle cx="5" cy="12" r="1" />
                          </svg>
                        </button>

                        <!-- Menu déroulant -->
                        <div
                          *ngIf="selectedCandidacyId === candidacy.id"
                          class="dropdown-menu absolute right-0 mt-1 w-48 bg-card border border-border rounded-md shadow-lg z-20 py-1 transition-all duration-200 origin-top-right"
                          @fadeInOut
                        >
                          <!-- Option Voir le profil -->
                          <button
                            [routerLink]="['/profile', candidacy.user.id]"
                            class="flex items-center w-full px-4 py-2 text-sm text-foreground hover:bg-muted/50 transition-colors"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="16"
                              height="16"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              class="lucide lucide-user mr-2"
                            >
                              <path
                                d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"
                              />
                              <circle cx="12" cy="7" r="4" />
                            </svg>
                            Voir le profil
                          </button>

                          <!-- Option Valider -->
                          <button
                            (click)="onValidate(candidacy.id)"
                            class="flex items-center w-full px-4 py-2 text-sm text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="16"
                              height="16"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              class="lucide lucide-check-circle mr-2"
                            >
                              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                              <polyline points="22 4 12 14.01 9 11.01" />
                            </svg>
                            Valider
                          </button>

                          <!-- Option Rejeter -->
                          <button
                            (click)="onReject(candidacy.id)"
                            class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="16"
                              height="16"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              class="lucide lucide-x-circle mr-2"
                            >
                              <circle cx="12" cy="12" r="10" />
                              <line x1="15" y1="9" x2="9" y2="15" />
                              <line x1="9" y1="9" x2="15" y2="15" />
                            </svg>
                            Rejeter
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div
              *ngIf="candidacyMeta && candidacyMeta.last_page > 1"
              class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4"
            >
              <div class="text-sm text-muted-foreground">
                Affichage
                <span class="font-medium text-foreground">{{
                  (candidacyMeta.current_page - 1) * candidacyMeta.per_page + 1
                }}</span>
                à
                <span class="font-medium text-foreground">{{
                  Math.min(
                    candidacyMeta.current_page * candidacyMeta.per_page,
                    candidacyMeta.total
                  )
                }}</span>
                sur
                <span class="font-medium text-foreground">{{
                  candidacyMeta.total
                }}</span>
                résultats
              </div>

              <div class="flex items-center gap-1">
                <button
                  (click)="onPageChange(1)"
                  [disabled]="candidacyMeta.current_page === 1"
                  class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition"
                >
                  «
                </button>
                <button
                  (click)="onPageChange(candidacyMeta.current_page - 1)"
                  [disabled]="candidacyMeta.current_page === 1"
                  class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition"
                >
                  ‹
                </button>

                <ng-container *ngFor="let page of getPageNumbers()">
                  <button
                    (click)="onPageChange(page)"
                    [class.bg-primary]="page === candidacyMeta.current_page"
                    [class.text-primary-foreground]="
                      page === candidacyMeta.current_page
                    "
                    class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition"
                  >
                    {{ page }}
                  </button>
                </ng-container>

                <button
                  (click)="onPageChange(candidacyMeta.current_page + 1)"
                  [disabled]="
                    candidacyMeta.current_page === candidacyMeta.last_page
                  "
                  class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition"
                >
                  ›
                </button>
                <button
                  (click)="onPageChange(candidacyMeta.last_page)"
                  [disabled]="
                    candidacyMeta.current_page === candidacyMeta.last_page
                  "
                  class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition"
                >
                  »
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Onglet Invitations -->
        <div *ngIf="activeTab === 'invitations'">
          <!-- Filtres -->
          <div class="p-4 border-b border-border">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold text-foreground">Invitations</h2>
              <span
                *ngIf="invitationMeta"
                class="text-sm text-muted-foreground"
              >
                {{ invitationMeta.total }} résultat(s)
              </span>
              <button
                (click)="refreshInvitations()"
                [disabled]="isLoading"
                class="p-1.5 rounded-md hover:bg-muted transition"
                title="Actualiser les invitations"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  [class.animate-spin]="isLoading"
                >
                  <path
                    d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                  />
                  <path d="M3 3v5h5" />
                  <path
                    d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"
                  />
                  <path d="M16 16h5v5" />
                </svg>
              </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mt-3">
              <div>
                <label class="block text-sm font-medium text-foreground mb-1"
                  >Rôle</label
                >
                <input
                  type="text"
                  [(ngModel)]="invitationRoleFilter"
                  placeholder="Rôle"
                  class="w-full text-sm rounded-md border border-input bg-background px-3 py-2 shadow-sm focus:ring-2 focus:ring-ring focus:ring-offset-2"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-foreground mb-1"
                  >Email</label
                >
                <input
                  type="text"
                  [(ngModel)]="invitationEmailFilter"
                  placeholder="Email"
                  class="w-full text-sm rounded-md border border-input bg-background px-3 py-2 shadow-sm focus:ring-2 focus:ring-ring focus:ring-offset-2"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-foreground mb-1"
                  >Statut</label
                >
                <select
                  [(ngModel)]="invitationStatusFilter"
                  class="w-full text-sm rounded-md border border-input bg-background px-3 py-2 shadow-sm focus:ring-2 focus:ring-ring focus:ring-offset-2"
                >
                  <option [ngValue]="null">Tous</option>
                  <option value="pending">En attente</option>
                  <option value="accepted">Accepté</option>
                  <option value="declined">Refusé</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-foreground mb-1"
                  >Par page</label
                >
                <select
                  [(ngModel)]="perPage"
                  (change)="onInvitationPerPageChange()"
                  class="w-full text-sm rounded-md border border-input bg-background px-3 py-2 shadow-sm focus:ring-2 focus:ring-ring focus:ring-offset-2"
                >
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="20">20</option>
                </select>
              </div>
              <div class="flex items-end gap-2">
                <button
                  (click)="applyInvitationFilters()"
                  class="w-full text-sm bg-primary text-primary-foreground px-3 py-2 rounded-md hover:bg-primary/90 transition"
                >
                  Appliquer
                </button>
                <button
                  (click)="resetInvitationFilters()"
                  class="w-full text-sm border border-input px-3 py-2 rounded-md hover:bg-muted transition"
                >
                  Réinitialiser
                </button>
              </div>
            </div>
          </div>

          <!-- Tableau des Invitations -->
          <div class="p-4">
            <div class="overflow-x-auto rounded-lg border border-border">
              <table class="min-w-full text-sm text-left">
                <thead class="bg-muted">
                  <tr>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Candidat
                    </th>
                    <th class="px-4 py-3 font-medium text-foreground">Email</th>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Rôle Invité
                    </th>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Statut
                    </th>
                    <th class="px-4 py-3 font-medium text-foreground">Date</th>
                    <th class="px-4 py-3 font-medium text-foreground">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border">
                  <!-- État de Chargement -->
                  <tr *ngIf="isLoading">
                    <td colspan="6" class="py-6 text-center">
                      <div class="flex justify-center items-center space-x-2">
                        <div
                          class="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-primary"
                        ></div>
                        <span class="text-muted-foreground">Chargement...</span>
                      </div>
                    </td>
                  </tr>

                  <!-- État Vide -->
                  <tr *ngIf="!isLoading && invitations.length === 0">
                    <td colspan="6" class="py-6 text-center">
                      <div
                        class="flex flex-col items-center justify-center space-y-2 text-muted-foreground"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          class="lucide lucide-file-search"
                        >
                          <path
                            d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3"
                          />
                          <path d="M14 2v6h6" />
                          <circle cx="10" cy="13" r="3" />
                          <path d="m12 12-1 1" />
                        </svg>
                        <span>Aucune invitation trouvée</span>
                      </div>
                    </td>
                  </tr>

                  <!-- Invitations -->
                  <tr
                    *ngFor="let invitation of invitations"
                    class="hover:bg-muted/50 transition-colors"
                  >
                    <td class="px-4 py-3 font-medium">
                      <div class="flex items-center space-x-3">
                        <div
                          class="flex-shrink-0 h-8 w-8 rounded-full bg-muted flex items-center justify-center"
                        >
                          <span
                            class="text-sm font-medium text-muted-foreground"
                          >
                            {{ invitation.email | slice : 0 : 1 | uppercase }}
                          </span>
                        </div>
                        <span class="text-foreground">{{
                          invitation.email
                        }}</span>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-muted-foreground">
                      {{ invitation.email }}
                    </td>
                    <td class="px-4 py-3">
                      <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-secondary text-secondary-foreground"
                      >
                        {{ invitation.project_role.role.name }}
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300':
                            invitation.status === 'pending',
                          'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300':
                            invitation.status === 'accepted',
                          'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300':
                            invitation.status === 'declined'
                        }"
                      >
                        {{
                          invitation.status === "pending"
                            ? "En attente"
                            : invitation.status === "accepted"
                            ? "Accepté"
                            : "Refusé"
                        }}
                      </span>
                    </td>
                    <td
                      class="px-4 py-3 whitespace-nowrap text-muted-foreground"
                    >
                      {{ invitation.created_at | date : "dd/MM/yyyy" }}
                    </td>
                    <td class="px-4 py-3 relative">
                      <!-- Bouton d'actions -->
                      <div class="dropdown relative">
                        <button
                          (click)="toggleViewMenuInvite(invitation.id)"
                          class="inline-flex items-center justify-center p-2 rounded-md hover:bg-muted/50 transition-colors"
                          aria-label="Actions"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            class="lucide lucide-more-horizontal"
                          >
                            <circle cx="12" cy="12" r="1" />
                            <circle cx="19" cy="12" r="1" />
                            <circle cx="5" cy="12" r="1" />
                          </svg>
                        </button>

                        <!-- Menu déroulant -->
                        <div
                          *ngIf="selectedInvitationId === invitation.id"
                          class="dropdown-menu absolute right-0 mt-1 w-48 bg-card border border-border rounded-md shadow-lg z-20 py-1 transition-all duration-200 origin-top-right"
                          @fadeInOut
                        >
                          <!-- Option Renvoyer -->
                          <button
                            [disabled]="invitation.status === 'accepted'"
                            class="flex items-center w-full px-4 py-2 text-sm text-foreground hover:bg-muted/50 transition-colors disabled:opacity-50"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="16"
                              height="16"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              class="lucide lucide-send mr-2"
                            >
                              <path d="m22 2-7 20-4-9-9-4Z" />
                              <path d="M22 2 11 13" />
                            </svg>
                            Renvoyer
                          </button>

                          <!-- Option Annuler -->
                          <button
                            (click)="cancel(invitation.id)"
                            [disabled]="invitation.status !== 'pending'"
                            class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors disabled:opacity-50"
                          >
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              width="16"
                              height="16"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              class="lucide lucide-x-circle mr-2"
                            >
                              <circle cx="12" cy="12" r="10" />
                              <line x1="15" y1="9" x2="9" y2="15" />
                              <line x1="9" y1="9" x2="15" y2="15" />
                            </svg>
                            Annuler
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div
              *ngIf="invitationMeta && invitationMeta.last_page > 1"
              class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4"
            >
              <div class="text-sm text-muted-foreground">
                Affichage
                <span class="font-medium text-foreground">{{
                  (invitationMeta.current_page - 1) * invitationMeta.per_page +
                    1
                }}</span>
                à
                <span class="font-medium text-foreground">{{
                  Math.min(
                    invitationMeta.current_page * invitationMeta.per_page,
                    invitationMeta.total
                  )
                }}</span>
                sur
                <span class="font-medium text-foreground">{{
                  invitationMeta.total
                }}</span>
                résultats
              </div>

              <div class="flex items-center gap-1">
                <button
                  (click)="onInvitationPageChange(1)"
                  [disabled]="invitationMeta.current_page === 1"
                  class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition"
                >
                  «
                </button>
                <button
                  (click)="
                    onInvitationPageChange(invitationMeta.current_page - 1)
                  "
                  [disabled]="invitationMeta.current_page === 1"
                  class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition"
                >
                  ‹
                </button>

                <ng-container *ngFor="let page of getInvitationPageNumbers()">
                  <button
                    (click)="onInvitationPageChange(page)"
                    [class.bg-primary]="page === invitationMeta.current_page"
                    [class.text-primary-foreground]="
                      page === invitationMeta.current_page
                    "
                    class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium hover:bg-muted transition"
                  >
                    {{ page }}
                  </button>
                </ng-container>

                <button
                  (click)="
                    onInvitationPageChange(invitationMeta.current_page + 1)
                  "
                  [disabled]="
                    invitationMeta.current_page === invitationMeta.last_page
                  "
                  class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition"
                >
                  ›
                </button>
                <button
                  (click)="onInvitationPageChange(invitationMeta.last_page)"
                  [disabled]="
                    invitationMeta.current_page === invitationMeta.last_page
                  "
                  class="px-3 py-1.5 rounded-md border border-input bg-background text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-muted transition"
                >
                  »
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Vue pour les autres utilisateurs -->
  <ng-container *ngIf="!isOwner">
    <div class="grid gap-6">
      <!-- Section Principale -->
      <section class="bg-card rounded-lg border border-border p-6">
        <!-- Description -->
        <div class="mb-6">
          <h3 class="text-base font-medium text-foreground mb-2">
            Description
          </h3>
          <p class="text-muted-foreground leading-relaxed whitespace-pre-line">
            {{ project.description || "Aucune description fournie" }}
          </p>
        </div>

        <!-- Statut et Domaines -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <h3 class="text-base font-medium text-foreground mb-2">
              Statut du projet
            </h3>
            <span
              class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium border"
              [ngClass]="{
                'bg-green-500/10 text-green-600 border-green-500/20':
                  project.status.name === 'En cours',
                'bg-red-500/10 text-red-600 border-red-500/20':
                  project.status.name === 'Terminé',
                'bg-accent text-foreground border-border':
                  project.status.name !== 'En cours' &&
                  project.status.name !== 'Terminé'
              }"
            >
              {{ project.status.name }}
            </span>
          </div>

          <div>
            <h3 class="text-base font-medium text-foreground mb-2">
              Domaines concernés
            </h3>
            <div class="flex flex-wrap gap-2">
              <span
                *ngFor="let domain of project.domains"
                class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-orange-500/10 text-orange-600 border border-orange-500/20"
              >
                {{ domain.name }}
              </span>
              <span
                *ngIf="!project.domains?.length"
                class="text-sm text-muted-foreground"
              >
                Aucun domaine spécifié
              </span>
            </div>
          </div>
        </div>

        <!-- Dates importantes -->
        <div class="mb-6">
          <h3 class="text-base font-medium text-foreground mb-3">
            Dates importantes
          </h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div
              class="flex items-center gap-3 p-3 bg-accent rounded-lg border border-border"
            >
              <div class="p-2 rounded-lg bg-accent text-muted-foreground">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M8 2v4"></path>
                  <path d="M16 2v4"></path>
                  <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                  <path d="M3 10h18"></path>
                </svg>
              </div>
              <div>
                <p class="text-xs text-muted-foreground">Début</p>
                <p class="text-sm font-medium text-foreground">
                  {{ project.date_start | date : "d MMM yyyy" | lowercase }}
                </p>
              </div>
            </div>

            <div
              class="flex items-center gap-3 p-3 bg-accent rounded-lg border border-border"
            >
              <div class="p-2 rounded-lg bg-accent text-muted-foreground">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M8 2v4"></path>
                  <path d="M16 2v4"></path>
                  <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                  <path d="M3 10h18"></path>
                  <path d="M9 16l2 2 4-4"></path>
                </svg>
              </div>
              <div>
                <p class="text-xs text-muted-foreground">Fin prévue</p>
                <p class="text-sm font-medium text-foreground">
                  {{ project.date_end | date : "d MMM yyyy" | lowercase }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Section Rôles -->
      <section>
        <div class="flex justify-start items-center mb-4">
          <h2 class="text-lg font-semibold text-foreground">
            Postes à pourvoir ({{ project.project_roles_skills.length }})
          </h2>
        </div>

        <div class="space-y-2">
          <ng-container
            *ngFor="
              let roleSkill of project.project_roles_skills;
              let i = index
            "
          >
            <div class="border border-border rounded-lg overflow-hidden">
              <!-- En-tête de l'accordéon -->
              <button
                (click)="toggleAccordion(i)"
                class="w-full flex justify-between items-center p-4 hover:bg-accent transition-colors"
              >
                <div class="flex items-center gap-3">
                  <h3 class="text-base font-semibold text-foreground text-left">
                    {{ roleSkill.role.name }}
                  </h3>
                  <div class="flex flex-wrap gap-1">
                    <span
                      *ngFor="let skill of roleSkill.skills"
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-500/10 text-orange-500"
                    >
                      {{ skill.name }}
                    </span>
                  </div>
                </div>
                <svg
                  [class.rotate-180]="isOpen[i]"
                  class="w-5 h-5 text-muted-foreground transform transition-transform"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>

              <!-- Contenu de l'accordéon -->
              <div
                [class.hidden]="!isOpen[i]"
                class="p-4 pt-0 border-t border-border"
              >
                <div class="flex flex-col gap-4">
                  <div>
                    <p class="text-muted-foreground">
                      {{
                        roleSkill.description ||
                          "Aucune description spécifique pour ce rôle."
                      }}
                    </p>
                  </div>

                  <div *ngIf="roleSkill.skills.length > 0" class="mt-2">
                    <h4 class="text-sm font-medium text-foreground mb-2">
                      Compétences requises
                    </h4>
                    <div class="flex flex-wrap gap-2">
                      <span
                        *ngFor="let skill of roleSkill.skills"
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-500/10 text-orange-500"
                      >
                        {{ skill.name }}
                      </span>
                    </div>
                  </div>

                  <div class="flex justify-end items-center mt-4">
                    <button
                      (click)="openCandidacyModal(roleSkill)"
                      class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary/90"
                    >
                      Postuler
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </section>
    </div>
  </ng-container>

  <!-- Modal d'Invitation -->
  <div
    *ngIf="showInviteModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
    aria-modal="true"
  >
    <div
      class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
      (click)="cancelInvite()"
    ></div>

    <div
      class="relative w-full max-w-md rounded-xl border border-border bg-card shadow-lg transition-all duration-300"
    >
      <div class="p-6">
        <!-- En-tête -->
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-foreground">
            Invitation pour : {{ selectedRole?.role.name }}
          </h2>
          <button
            (click)="cancelInvite()"
            class="rounded-sm p-1 opacity-70 hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M18 6 6 18"></path>
              <path d="m6 6 12 12"></path>
            </svg>
            <span class="sr-only">Fermer</span>
          </button>
        </div>

        <!-- Contenu -->
        <div class="space-y-4">
          <div>
            <label
              for="invite-email"
              class="block text-sm font-medium mb-2 text-foreground"
            >
              Adresse email
            </label>
            <input
              id="invite-email"
              type="email"
              [(ngModel)]="inviteEmail"
              class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm shadow-sm focus:border-primary focus:outline-none focus:ring-primary"
              placeholder="email@exemple.com"
              required
            />
          </div>

          <div *ngIf="selectedRole" class="rounded-md bg-accent p-4">
            <h4 class="text-sm font-medium mb-2 text-foreground">
              Rôle à attribuer :
            </h4>
            <div class="flex items-center gap-2">
              <span
                class="inline-flex items-center rounded-full bg-accent px-2.5 py-0.5 text-xs font-medium text-foreground"
              >
                {{ selectedRole.role.name }}
              </span>
              <span class="text-sm text-muted-foreground">
                {{ selectedRole.skills.length }} compétences requises
              </span>
            </div>
          </div>
        </div>

        <!-- Pied de page -->
        <div class="mt-6 flex justify-end gap-2">
          <button
            (click)="cancelInvite()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium px-3 py-2 border border-input bg-background shadow-sm hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ring"
          >
            Annuler
          </button>
          <button
            (click)="sendInvite()"
            [disabled]="!inviteEmail"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium px-3 py-2 border border-transparent shadow-sm text-primary-foreground bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ring disabled:opacity-50 gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m22 2-7 20-4-9-9-4Z"></path>
              <path d="M22 2 11 13"></path>
            </svg>
            Envoyer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmation de Candidature -->
  <div
    *ngIf="showCandidacyModal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4"
    aria-modal="true"
  >
    <div
      class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
      (click)="cancelCandidacy()"
    ></div>

    <div
      class="relative w-full max-w-md rounded-xl border border-border bg-card shadow-lg transition-all duration-300"
    >
      <div class="p-6">
        <!-- En-tête -->
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-foreground">
            Confirmer la Candidature
          </h2>
          <button
            (click)="cancelCandidacy()"
            class="rounded-sm p-1 opacity-70 hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M18 6 6 18"></path>
              <path d="m6 6 12 12"></path>
            </svg>
            <span class="sr-only">Fermer</span>
          </button>
        </div>

        <!-- Contenu -->
        <div class="space-y-4">
          <p class="text-muted-foreground">
            Êtes-vous sûr de vouloir postuler pour le rôle
            <strong>{{ selectedRole?.role?.name }}</strong
            >?
          </p>

          <div
            *ngIf="selectedRole?.skills?.length"
            class="rounded-md bg-accent p-4"
          >
            <h4 class="text-sm font-medium mb-2 text-foreground">
              Compétences Requises :
            </h4>
            <div class="flex flex-wrap gap-2">
              <span
                *ngFor="let skill of selectedRole.skills"
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-500/10 text-orange-500"
              >
                {{ skill.name }}
              </span>
            </div>
          </div>
        </div>

        <!-- Pied de page -->
        <div class="mt-6 flex justify-end gap-2">
          <button
            (click)="cancelCandidacy()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium px-3 py-2 border border-input bg-background shadow-sm hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ring"
          >
            Annuler
          </button>
          <button
            (click)="confirmCandidacy()"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium px-3 py-2 border border-transparent shadow-sm text-primary-foreground bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-ring gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M20 6 9 17l-5-5"></path>
            </svg>
            Confirmer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
