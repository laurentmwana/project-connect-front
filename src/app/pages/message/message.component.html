<div class="flex h-full overflow-hidden bg-background">
  <!-- Liste des chats -->
  <div class="w-full md:w-1/3 border-r border-border flex flex-col bg-card h-full">
    <!-- Barre de recherche -->
    <div class="p-3 border-b border-border bg-popover">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="Rechercher une conversation"
        class="w-full px-3 py-2 border border-input rounded-md text-sm bg-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-1"
      />
    </div>

    <!-- Onglets -->
    <div class="flex border-b border-border bg-popover">
      <button
        (click)="setActiveTab('all')"
        [class]="activeTab === 'all' ? 'py-2 w-full text-primary font-medium border-b-2 border-primary' : 'py-2 w-full text-muted-foreground hover:text-foreground transition-colors'"
      >
        Tous
      </button>
      <button
        (click)="setActiveTab('projects')"
        [class]="activeTab === 'projects' ? 'py-2 w-full text-primary font-medium border-b-2 border-primary' : 'py-2 w-full text-muted-foreground hover:text-foreground transition-colors'"
      >
        Projets
      </button>
    </div>

    <!-- Liste des chats -->
    <div class="flex-1 overflow-y-auto">
      <div
        *ngIf="isLoadingChats"
        class="p-4 text-center text-muted-foreground text-sm"
      >
        Chargement des conversations...
      </div>
      <div
        *ngIf="error"
        class="p-4 text-center text-destructive text-sm"
      >
        {{ error }}
        <button (click)="retryLoadChats()" class="ml-1 underline text-primary hover:text-primary/80">Réessayer</button>
      </div>
      <div class="overflow-y-auto max-h-[400px]">
        <div
          *ngFor="let chat of filteredChats; trackBy: trackByChat"
          class="p-2 border-b border-border hover:bg-accent/50 cursor-pointer flex justify-between items-center"
          (click)="selectChat(chat)"
          [class.bg-accent]="selectedChat?.id === chat.id"
        >
          <div class="flex-1 min-w-0 truncate">
            <div class="font-medium truncate text-sm">{{ getChatDisplayName(chat) }}</div>
            <div class="text-xs text-muted-foreground truncate">{{ getLastMessagePreview(chat) }}</div>
          </div>
          <div class="text-xs text-muted-foreground ml-2 whitespace-nowrap">{{ getChatTime(chat) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fenêtre de chat -->
  <div class="w-full md:w-2/3 flex flex-col h-full bg-background">
    <!-- Aucun chat sélectionné -->
    <div *ngIf="!selectedChat" class="flex-1 flex flex-col items-center justify-center text-muted-foreground p-8">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-4 opacity-70">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <h3 class="text-lg font-medium mb-2">Sélectionnez une conversation</h3>
      <p class="text-sm text-center max-w-md">Choisissez une conversation existante ou démarrez-en une nouvelle pour commencer à discuter.</p>
    </div>

    <!-- Affichage des messages -->
    <div *ngIf="selectedChat" class="flex flex-col h-full">
      <!-- En-tête -->
      <div class="p-3 border-b border-border bg-popover flex items-center justify-between">
        <h2 class="text-lg font-semibold truncate max-w-[70%]">{{ getChatDisplayName(selectedChat) }}</h2>
        <div class="flex gap-2">
          <button class="p-1.5 rounded-full hover:bg-accent text-muted-foreground">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
            </svg>
          </button>
          <button class="p-1.5 rounded-full hover:bg-accent text-muted-foreground">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Liste des messages -->
      <div #messagesContainer class="flex-1 overflow-y-auto p-4 space-y-3 max-h-[400px]">
        <div *ngIf="isLoadingMessages" class="text-center text-muted-foreground py-4 text-sm">
          Chargement des messages...
        </div>

        <div *ngIf="error && !isLoadingMessages" class="text-center text-destructive text-sm">
          {{ error }}
          <button (click)="retryLoadMessages()" class="ml-1 underline text-primary hover:text-primary/80">Réessayer</button>
        </div>

        <div *ngFor="let message of messages; trackBy: trackByMessage" class="flex gap-2" [class.justify-end]="isOwnMessage(message)">
          <div *ngIf="!isOwnMessage(message)" class="flex-shrink-0 h-7 w-7 rounded-full bg-accent flex items-center justify-center text-accent-foreground text-xs font-medium">
            {{ message.sender.name.charAt(0) }}
          </div>
          <div class="flex flex-col" [class.items-end]="isOwnMessage(message)">
            <div *ngIf="!isOwnMessage(message)" class="text-xs font-medium text-muted-foreground mb-1">
              {{ message.sender.name }}
            </div>
            <div class="flex gap-2" [class.flex-row-reverse]="isOwnMessage(message)">
              <div
                [ngClass]="{
                  'bg-primary text-primary-foreground': isOwnMessage(message),
                  'bg-card text-card-foreground border border-border': !isOwnMessage(message)
                }"
                class="rounded-lg p-2 shadow-sm max-w-[80%]"
              >
                <p class="text-sm">{{ message.message }}</p>
              </div>
              <div class="text-xs text-muted-foreground self-end">
                {{ getMessageTime(message) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Zone de saisie -->
      <form class="p-3 border-t border-border bg-popover flex items-end gap-2" (submit)="sendMessage()">
        <div class="flex-1 relative">
          <textarea
            [(ngModel)]="newMessage"
            name="message"
            (keydown)="onKeyPress($event)"
            rows="1"
            placeholder="Écrivez un message..."
            class="w-full px-3 py-2 border border-input rounded-xl text-sm bg-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-1 resize-none min-h-[40px] max-h-[120px]"
          ></textarea>
        </div>
        <button
          type="submit"
          [disabled]="isLoading || !newMessage.trim()"
          class="h-10 w-10 flex items-center justify-center bg-primary text-primary-foreground rounded-xl text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-primary/90 transition-colors"
        >
          <svg *ngIf="!isLoading" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          <svg *ngIf="isLoading" class="animate-spin w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
        </button>
      </form>
    </div>
  </div>
</div>
